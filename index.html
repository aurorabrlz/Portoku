<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portfolio Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-3xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-6 text-center">Portfolio Tracker</h1>

    <!-- Currency -->
    <select id="currencySelect" onchange="render()">...</select>

    <!-- Add Equity / Withdraw -->
    <input id="topupInput" /><button onclick="addTrans('topup')">Top Up</button>
    <input id="withdrawInput" /><button onclick="addTrans('withdraw')">Withdraw</button>

    <!-- Edit Allocation & Emiten -->
    <div id="allocations"></div>
    <button onclick="saveAlloc()">Save Alokasi</button>

    <!-- Displays -->
    <div id="portfolioDisplay"></div>
    <div id="historyDisplay"></div>

    <!-- Backup/Import -->
    <button onclick="downloadBackup()">Backup Data</button>
    <input type="file" onchange="importData(event)" />
  </div>

  <script>
    let currency = localStorage.getItem("currency") || "IDR";
    let allocations = JSON.parse(localStorage.getItem("alloc")) || [
      { ticker:"BBCA.JK", name:"BBCA", pct:25 },
      { ticker:"GOOGL", name:"GOOGL", pct:25 },
      { ticker:"BTC", name:"BTC", pct:30 },
      { ticker:"CASH", name:"CASH", pct:20 },
    ];
    let history = JSON.parse(localStorage.getItem("history")) || [];

    async function fetchPrice(ticker){
      const key = 'YOUR_API_KEY';
      const url = `https://api.twelvedata.com/price?symbol=${ticker}&apikey=${key}`;
      const res = await fetch(url);
      const d = await res.json();
      return parseFloat(d.price);
    }

    async function render(){
      // build allocation edit UI
      let html = '<table>';
      allocations.forEach((a,i)=>{
        html+=`<tr>
          <td><input value="${a.ticker}" onchange="allocations[${i}].ticker=this.value"/></td>
          <td><input value="${a.pct}" onchange="allocations[${i}].pct=parseFloat(this.value)"/></td>
        </tr>`;
      });
      html+='</table>';
      document.getElementById('allocations').innerHTML = html;

      // compute total equity
      const total = history.reduce((s,h)=> s + (h.type=='withdraw'?-h.amount:h.amount),0);

      // display portfolio
      let pfHTML = `<p><strong>Total Equity:</strong>${formatC(total)}</p>`;
      for(const a of allocations){
        const price = await fetchPrice(a.ticker);
        const value = total * a.pct/100;
        pfHTML += `<p>${a.name} (${a.ticker}) : ${formatC(value)} â‰ˆ ${(value/price).toFixed(2)} shares @ ${formatC(price)}</p>`;
      }
      document.getElementById('portfolioDisplay').innerHTML = pfHTML;

      // history
      document.getElementById('historyDisplay').innerHTML = history.map(h=> `<p>${h.date} - ${h.type.toUpperCase()} - ${formatC(h.amount)}</p>`).join('');
    }

    function formatC(v){
      return new Intl.NumberFormat(currency=="USD"?"en-US":"id-ID",{style:"currency",currency}).format(v);
    }

    function addTrans(type){
      const val = parseFloat(document.getElementById(type + 'Input').value);
      if(!isNaN(val)){
        history.push({type,amount:val,date:new Date().toISOString()});
        localStorage.setItem("history", JSON.stringify(history));
        render();
      }
    }

    function saveAlloc(){
      localStorage.setItem("alloc", JSON.stringify(allocations));
      render();
    }

    function downloadBackup(){
      const d = {currency, history, allocations};
      const blob=new Blob([JSON.stringify(d)],{type:"application/json"});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download='backup.json'; a.click();
    }
    function importData(e){
      const f=e.target.files[0]; 
      const r=new FileReader();
      r.onload=_=>{
        const d=JSON.parse(r.result);
        history=d.history; allocations=d.allocations; currency=d.currency;
        localStorage.setItem("history", JSON.stringify(history));
        localStorage.setItem("currency",currency);
        localStorage.setItem("alloc", JSON.stringify(allocations));
        render();
      }
      r.readAsText(f);
    }

    render();
  </script>
</body>
</html>
