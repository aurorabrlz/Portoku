<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portfolio Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-800">
  <div class="max-w-3xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-6 text-center">Portfolio Tracker</h1>

    <!-- Currency Switch -->
    <div class="mb-4">
      <label for="currencySelect" class="block font-semibold mb-1">Pilih Mata Uang:</label>
      <select id="currencySelect" onchange="switchCurrency()" class="w-full p-2 rounded border">
        <option value="IDR">IDR</option>
        <option value="USD">USD</option>
      </select>
    </div>

    <!-- Equity Input -->
    <div class="mb-4">
      <label for="topupInput" class="block font-semibold mb-1">Top Up:</label>
      <input type="number" id="topupInput" placeholder="Jumlah top up" class="w-full p-2 rounded border">
      <button onclick="addTopup()" class="bg-blue-500 text-white px-4 py-2 rounded mt-2 hover:bg-blue-600">Tambah</button>
    </div>

    <!-- Portfolio Display -->
    <div id="portfolioDisplay" class="bg-white p-4 rounded shadow mb-6"></div>

    <!-- History Display -->
    <div id="historyDisplay" class="bg-white p-4 rounded shadow mb-6"></div>

    <!-- Backup & Import -->
    <div class="flex gap-2 mt-4">
      <button onclick="downloadBackup()" class="bg-green-600 text-white px-4 py-2 rounded-xl shadow hover:bg-green-700">
        Backup Data
      </button>

      <label for="importFile" class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow hover:bg-blue-700 cursor-pointer">
        Import Data
        <input type="file" id="importFile" accept=".json" onchange="importData(event)" class="hidden" />
      </label>
    </div>
  </div>

  <script>
    let currency = localStorage.getItem("currency") || "IDR";
    let history = JSON.parse(localStorage.getItem("history")) || [];

    // Alokasi default
    const allocation = [
      { name: "BBCA", percent: 0.25 },
      { name: "GOOGL", percent: 0.25 },
      { name: "BTC", percent: 0.30 },
      { name: "CASH", percent: 0.20 }
    ];

    function switchCurrency() {
      currency = document.getElementById("currencySelect").value;
      localStorage.setItem("currency", currency);
      render();
    }

    function addTopup() {
      const amount = parseFloat(document.getElementById("topupInput").value);
      if (!isNaN(amount)) {
        history.push({ type: 'topup', amount, date: new Date().toISOString() });
        save();
      }
    }

    function save() {
      localStorage.setItem("history", JSON.stringify(history));
      render();
    }

    function render() {
      document.getElementById("currencySelect").value = currency;

      const totalEquity = getTotalEquity();
      let portfolioHTML = `<h2 class="text-xl font-bold mb-2">Equity</h2><p class="mb-4">${formatCurrency(totalEquity)}</p><h3 class="font-semibold mb-2">Alokasi:</h3>`;
      allocation.forEach(item => {
        const value = totalEquity * item.percent;
        portfolioHTML += `<p>${item.name}: ${formatCurrency(value)} (${(item.percent * 100).toFixed(0)}%)</p>`;
      });
      document.getElementById("portfolioDisplay").innerHTML = portfolioHTML;

      let historyHTML = '<h2 class="text-xl font-bold mb-2">History</h2>';
      history.slice().reverse().forEach(entry => {
        historyHTML += `<p>${entry.date.split("T")[0]} - ${entry.type} - ${formatCurrency(entry.amount)}</p>`;
      });
      document.getElementById("historyDisplay").innerHTML = historyHTML;
    }

    function getTotalEquity() {
      return history.reduce((sum, item) => sum + item.amount, 0);
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat(currency === "USD" ? "en-US" : "id-ID", {
        style: "currency",
        currency: currency,
      }).format(amount);
    }

    function downloadBackup() {
      const data = {
        history: localStorage.getItem("history"),
        currency: localStorage.getItem("currency"),
      };

      const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `portfolio_backup_${new Date().toISOString().split("T")[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data.history) localStorage.setItem("history", data.history);
          if (data.currency) localStorage.setItem("currency", data.currency);
          alert("Data berhasil diimpor!");
          location.reload();
        } catch (err) {
          alert("File tidak valid atau rusak.");
        }
      };
      reader.readAsText(file);
    }

    render();
  </script>
</body>

</html>
